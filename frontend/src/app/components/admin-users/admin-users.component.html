<div class="users-container">
  <div class="header">
    <div class="header-content">
      <button class="btn-back" (click)="goBack()">
        ‚Üê Volver
      </button>
      <div>
        <h1>üë• Gesti√≥n de Usuarios</h1>
        <p>Administra usuarios del sistema</p>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn-danger" (click)="deleteTestUsers()" *ngIf="currentUser?.role === 'master'">
        üóëÔ∏è Limpiar Pruebas
      </button>
      <button class="btn-primary" (click)="showCreateForm = !showCreateForm">
        {{ showCreateForm ? 'Cancelar' : '+ Crear Usuario' }}
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card total">
      <div class="stat-icon">üë•</div>
      <div class="stat-info">
        <h3>{{ users.length }}</h3>
        <p>Total Usuarios</p>
      </div>
    </div>
    <div class="stat-card patients">
      <div class="stat-icon">üßë‚öïÔ∏è</div>
      <div class="stat-info">
        <h3>{{ getUsersByRole('patient').length }}</h3>
        <p>Pacientes</p>
      </div>
    </div>
    <div class="stat-card professionals">
      <div class="stat-icon">üë®‚öïÔ∏è</div>
      <div class="stat-info">
        <h3>{{ getUsersByRole('professional').length }}</h3>
        <p>Profesionales</p>
      </div>
    </div>
    <div class="stat-card admins">
      <div class="stat-icon">üë®üíº</div>
      <div class="stat-info">
        <h3>{{ getUsersByRole('admin').length + getUsersByRole('master').length }}</h3>
        <p>Administradores</p>
      </div>
    </div>
  </div>

  <!-- Create User Form -->
  <div class="create-form-modal" *ngIf="showCreateForm">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Crear Nuevo Usuario</h3>
        <button class="btn-close" (click)="showCreateForm = false">√ó</button>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Email *</label>
          <input type="email" [(ngModel)]="newUser.email" placeholder="usuario@ejemplo.com">
        </div>
        
        <div class="form-group">
          <label>Contrase√±a *</label>
          <input type="password" [(ngModel)]="newUser.password" placeholder="M√≠nimo 8 caracteres">
        </div>
        
        <div class="form-group">
          <label>Rol *</label>
          <select [(ngModel)]="newUser.role">
            <option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" [(ngModel)]="newUser.firstName" placeholder="Nombre">
        </div>
        
        <div class="form-group">
          <label>Apellido *</label>
          <input type="text" [(ngModel)]="newUser.lastName" placeholder="Apellido">
        </div>
        
        <div class="form-group">
          <label>DNI</label>
          <input type="text" [(ngModel)]="newUser.dni" placeholder="12345678">
        </div>
        
        <div class="form-group">
          <label>Tel√©fono</label>
          <input type="text" [(ngModel)]="newUser.phone" placeholder="+54911123456">
        </div>
        
        <div class="form-group" *ngIf="newUser.role === 'professional'">
          <label>Especialidad</label>
          <select [(ngModel)]="newUser.specialty">
            <option value="">Seleccionar especialidad</option>
            <option *ngFor="let specialty of specialties" [value]="specialty.name">{{ specialty.name }}</option>
          </select>
        </div>
        
        <div class="form-group" *ngIf="newUser.role === 'professional'">
          <label>Matr√≠cula</label>
          <input type="text" [(ngModel)]="newUser.licenseNumber" placeholder="MP12345">
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" (click)="showCreateForm = false; resetForm()">Cancelar</button>
        <button class="btn-primary" (click)="createUser()">Crear Usuario</button>
      </div>
    </div>
  </div>

  <!-- Edit User Form -->
  <div class="create-form-modal" *ngIf="showEditForm">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar Usuario</h3>
        <button class="btn-close" (click)="cancelEdit()">√ó</button>
      </div>
      
      <div class="form-grid">
        <div class="form-group">
          <label>Email *</label>
          <input type="email" [(ngModel)]="editingUser.email" placeholder="usuario@ejemplo.com">
        </div>
        
        <div class="form-group">
          <label>Nueva Contrase√±a</label>
          <input type="password" [(ngModel)]="editingUser.password" placeholder="Dejar vac√≠o para mantener actual">
        </div>
        
        <div class="form-group">
          <label>Rol *</label>
          <select [(ngModel)]="editingUser.role">
            <option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Nombre *</label>
          <input type="text" [(ngModel)]="editingUser.firstName" placeholder="Nombre">
        </div>
        
        <div class="form-group">
          <label>Apellido *</label>
          <input type="text" [(ngModel)]="editingUser.lastName" placeholder="Apellido">
        </div>
        
        <div class="form-group">
          <label>DNI</label>
          <input type="text" [(ngModel)]="editingUser.dni" placeholder="12345678">
        </div>
        
        <div class="form-group">
          <label>Tel√©fono</label>
          <input type="text" [(ngModel)]="editingUser.phone" placeholder="+54911123456">
        </div>
        
        <div class="form-group" *ngIf="editingUser.role === 'professional'">
          <label>Especialidad</label>
          <select [(ngModel)]="editingUser.specialty">
            <option value="">Seleccionar especialidad</option>
            <option *ngFor="let specialty of specialties" [value]="specialty.name">{{ specialty.name }}</option>
          </select>
        </div>
        
        <div class="form-group" *ngIf="editingUser.role === 'professional'">
          <label>Matr√≠cula</label>
          <input type="text" [(ngModel)]="editingUser.licenseNumber" placeholder="MP12345">
        </div>
      </div>
      
      <div class="form-actions">
        <button class="btn-secondary" (click)="cancelEdit()">Cancelar</button>
        <button class="btn-primary" (click)="updateUser()">Actualizar Usuario</button>
      </div>
    </div>
  </div>

  <!-- Users Grid -->
  <div class="users-section" *ngIf="!loading">
    <div class="section-header">
      <h2>Usuarios del Sistema</h2>
      <div class="filters">
        <select [(ngModel)]="selectedRole" (change)="filterUsers()">
          <option value="">Todos los roles</option>
          <option *ngFor="let role of roles" [value]="role.value">{{ role.label }}</option>
        </select>
      </div>
    </div>
    
    <div class="users-grid">
      <div class="user-card" *ngFor="let user of filteredUsers" [class.inactive]="!user.isActive">
        <div class="user-header">
          <div class="user-avatar">
            {{ (user.profile?.firstName || 'U').charAt(0) }}
          </div>
          <div class="user-basic-info">
            <h4>{{ user.profile?.firstName }} {{ user.profile?.lastName }}</h4>
            <p class="user-email">{{ user.email }}</p>
          </div>
          <div class="user-status">
            <span class="role-badge" [class]="user.role">
              {{ getRoleLabel(user.role) }}
            </span>
            <span class="status-indicator" [class]="user.isActive ? 'active' : 'inactive'">
              {{ user.isActive ? 'Activo' : 'Inactivo' }}
            </span>
          </div>
        </div>

        <div class="user-details">
          <div class="detail-item" *ngIf="user.profile?.dni">
            <span class="detail-label">DNI:</span>
            <span class="detail-value">{{ user.profile.dni }}</span>
          </div>
          <div class="detail-item" *ngIf="user.profile?.phone">
            <span class="detail-label">Tel√©fono:</span>
            <span class="detail-value">{{ user.profile.phone }}</span>
          </div>
          <div class="detail-item" *ngIf="user.professional?.specialty">
            <span class="detail-label">Especialidad:</span>
            <span class="detail-value">{{ user.professional.specialty }}</span>
          </div>
          <div class="detail-item" *ngIf="user.professional?.licenseNumber">
            <span class="detail-label">Matr√≠cula:</span>
            <span class="detail-value">{{ user.professional.licenseNumber }}</span>
          </div>
          <div class="detail-item">
            <span class="detail-label">Registro:</span>
            <span class="detail-value">{{ user.createdAt | date:'dd/MM/yyyy' }}</span>
          </div>
        </div>

        <div class="user-actions">
          <button 
            class="btn-action edit" 
            (click)="editUser(user)"
            [disabled]="!canManageUser(user)"
            title="Editar">
            ‚úèÔ∏è
          </button>
          
          <button 
            class="btn-action toggle" 
            (click)="toggleUserStatus(user)"
            [disabled]="!canManageUser(user)"
            [title]="user.isActive ? 'Desactivar' : 'Activar'">
            {{ user.isActive ? 'üîí' : 'üîì' }}
          </button>
          
          <button 
            class="btn-action delete" 
            (click)="deleteUser(user)"
            [disabled]="!canDeleteUser(user)"
            *ngIf="canDeleteUser(user)"
            title="Eliminar">
            üóëÔ∏è
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" *ngIf="loading">
    <div class="spinner"></div>
    <p>Cargando usuarios...</p>
  </div>
</div>